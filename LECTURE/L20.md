# Обмен данными по протоколу TCP
### Процессы TCP-сервера
---
Каждый процесс приложения, работающий на сервере, использует номер порта. Номер порта автоматически назначается или настраивается системным администратором вручную.  

Не допускается использование двумя различными службами на одном и том же сервере одного и того же порта с одинаковым протоколом транспортного уровня. Например, приложение веб-сервера и приложение передачи файлов, которые запущены на одном узле, не могут быть настроены на использование одного и того же порта (например, TCP-порта 80).  

Активное серверное приложение, которому присвоен какой-либо определенный порт, считается открытым, что означает, что транспортный уровень может принимать и обрабатывать сегменты, направляемые на этот порт. Любой входящий запрос, который адресован правильному сокету, будет принят, а данные будут переданы приложению сервера. На сервере может быть одновременно открыто сразу несколько портов, по одному для каждого активного приложения сервера.  

1. Клиенты, отправляющие запросы TCP

> Клиент 1 запрашивает веб-службы, а Клиент 2 запрашивает службу электронной почты, используя известные порты (например, веб-службы = порт 80, службы электронной почты = порт 25)

<img src="src\img\1.png" width="700px">  

2. Запрос Портов назначения

> Запросы динамически генерируют номер порта источника. В этом случае клиент 1 использует порт источника 49152, а клиент 2 использует порт источника 51152

<img src="src\img\2.png" width="700px">  

3. Запрос Портов источника

> Когда сервер отвечает на запросы клиента, он меняет порты назначения и источника исходного запроса.

<img src="src\img\3.png" width="700px">  

4. Ответ Портов назначения

> Обратите внимание, что ответ сервера на веб-запрос теперь имеет порт назначения 49152, а ответ электронной почты теперь имеет порт назначения 51152

<img src="src\img\4.png" width="700px">  

5. Ответ Портов источника

> Порт источника в ответе сервера является исходным портом назначения в первоначальных запросах

<img src="src\img\5.png" width="700px">  

### Установление TCP-соединения
---
В некоторых странах при встрече двух человек принято обмениваться рукопожатиями. Обе стороны понимают акт рукопожатия как сигнал для дружеского приветствия. Подключения в сети осуществляются примерно так же. В соединениях TCP клиент хоста устанавливает соединение с сервером, используя процесс трехстороннего рукопожатия.

Шаг 1. SYN

Инициирующий клиент запрашивает сеанс связи типа «клиент-сервер» с сервером.

Шаг 2. ACK и SYN

Сервер подтверждает сеанс обмена данными «клиент-сервер» и запрашивает сеанс обмена данными «сервер-клиент».

Шаг 3. ACK

Инициирующий клиент подтверждает сеанс связи «сервер-клиент».

> Трехстороннее рукопожатие подтверждает, что узел назначения доступен для связи. В этом примере узел A проверил, что узел B доступен.

### Прекращение TCP-соединения
---
Для прекращения соединения в заголовке сегмента должен быть установлен управляющий флаг Finish (FIN). Для завершения каждого одностороннего TCP-сеанса используется двухстороннее квитирование (рукопожатие), которое состоит из сегмента FIN и сегмента ACK (подтверждение). Следовательно, чтобы завершить один сеанс связи, поддерживаемый протоколом TCP, необходимы четыре операции обмена данными, которые завершат оба сеанса. Прекращение может инициировать клиент или сервер.

### Анализ трехстороннего квитирования TCP
---
Узлы отслеживают каждый сегмент данных, передаваемых во время сеанса, и обмениваются информацией о полученных данных с использованием сведений в заголовке TCP. TCP — это полнодуплексный протокол, в котором каждое соединение представляет два односторонних потока обмена данными или сеанса. Для установления связи узлы используют трехстороннее квитирование.  

Таковы функции трехстороннего квитирования:

- Определяет, присутствует ли в сети устройство назначения;
- Проверяет, имеется ли на устройстве назначения активная служба и принимает ли она запросы на номер порта назначения, который инициирующий клиент планирует использовать;
- Информирует устройство назначения, что клиент источника планирует установить сеанс связи на этом номере порта.

По завершении обмена данными все сеансы закрываются, а соединение прерывается. Механизмы подключения и осуществления сеанса связи включают в себя функции TCP, обеспечивающие надежность.

---

Шесть бит в поле битов управления в заголовке сегмента TCP называются флагами. Каждый флаг представляет собой бит, который либо включен, либо выключен.

Флаги шести битов управления выглядят следующим образом:

- URG - флаг «Указатель важности»;
- ACK - Флаг подтверждения, используемый при установке соединения и завершении сеанса;
- PSH - флаг "Push";
- RST - Флаг RST используется для сброса соединения при возникновении ошибки или в случае превышения времени ожидания;
- SYN - Синхронизирует порядковые номера, используемые при установке соединения;
- FIN - больше нет данных от отправителя, используется при завершении сеанса.